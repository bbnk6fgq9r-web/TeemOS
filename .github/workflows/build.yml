name: ðŸ—ï¸ Build Teemo Cat Edition ISO

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      aggressive_trim:
        description: 'Use aggressive trimming'
        required: false
        default: 'no'
        type: choice
        options:
          - 'no'
          - 'yes'

jobs:
  build-iso:
    runs-on: ubuntu-22.04
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ’¾ Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        df -h
        
    - name: ðŸ› ï¸ Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git curl rsync bc build-essential zstd xz-utils \
          squashfs-tools dosfstools syslinux-utils genisoimage cpio \
          wget gawk sed tar bzip2 xorriso coreutils util-linux pv
          
    - name: ðŸ“Š Show system info
      run: |
        echo "=== System Information ==="
        uname -a
        df -h
        free -h
        nproc
        
    - name: ðŸ¾ Clone woof-CE
      run: |
        mkdir -p ~/teemo
        cd ~/teemo
        git clone --depth 1 https://github.com/puppylinux-woof-CE/woof-CE.git
        
    - name: ðŸ§© Setup profile
      run: |
        cd ~/teemo/woof-CE
            mkdir -p woof-out-x86-64
            cp -r woof-distro/x86_64/slackware64/s15pup64 woof-out-x86-64/teemocat
            
    - name: âœ‚ï¸ Trim profile
      run: |
        chmod +x scripts/trim-profile.sh
        AGGRESSIVE_TRIM=${{ github.event.inputs.aggressive_trim || 'no' }} \
          ./scripts/trim-profile.sh ~/teemo/woof-CE/woof-out-x86-64/teemocat
          
    - name: ðŸ”— Run merge2out
      run: |
        cd ~/teemo/woof-CE
        sudo ./merge2out woof-out-x86-64/teemocat || true
        
    - name: ðŸ—ï¸ Build ISO - Step 1/4 (0setup)
      run: |
        cd ~/teemo/woof-CE/woof-out-x86-64/teemocat
        ./0setup
        
    - name: ðŸ“¥ Build ISO - Step 2/4 (1download)
      run: |
        cd ~/teemo/woof-CE/woof-out-x86-64/teemocat
        timeout 3600 ./1download || echo "Download step completed with warnings"
        
    - name: ðŸ“¦ Build ISO - Step 3/4 (2createpackages)
      run: |
        cd ~/teemo/woof-CE/woof-out-x86-64/teemocat
        ./2createpackages
        
    - name: ðŸŽ¯ Build ISO - Step 4/4 (3builddistro-Z)
      run: |
        cd ~/teemo/woof-CE/woof-out-x86-64/teemocat
        ./3builddistro-Z
        
    - name: ðŸ“ Check ISO size
      id: check_size
      run: |
        ISO_FILE=$(find ~/teemo/woof-CE/woof-out-x86-64/teemocat/woof-output -name "*.iso" -type f | head -n 1)
        if [ -n "$ISO_FILE" ]; then
          ISO_SIZE=$(stat -c%s "$ISO_FILE")
          ISO_SIZE_MB=$((ISO_SIZE / 1024 / 1024))
          echo "iso_path=$ISO_FILE" >> $GITHUB_OUTPUT
          echo "iso_size_mb=$ISO_SIZE_MB" >> $GITHUB_OUTPUT
          echo "âœ… ISO built: $ISO_FILE"
          echo "ðŸ“Š Size: ${ISO_SIZE_MB} MB"
          
          if [ $ISO_SIZE_MB -gt 3072 ]; then
            echo "âŒ ISO exceeds 3 GB limit!"
            exit 1
          elif [ $ISO_SIZE_MB -gt 900 ]; then
            echo "âš ï¸ ISO exceeds 900 MB target"
          else
            echo "âœ… ISO size within target!"
          fi
        else
          echo "âŒ No ISO file found!"
          exit 1
        fi
        
    - name: ðŸŽ‰ Prepare artifact
      run: |
        mkdir -p artifacts
        cp ${{ steps.check_size.outputs.iso_path }} artifacts/TeemoCat-${{ github.sha }}.iso
        echo "${{ steps.check_size.outputs.iso_size_mb }} MB" > artifacts/SIZE.txt
        echo "Built from commit ${{ github.sha }}" > artifacts/BUILD_INFO.txt
        echo "Date: $(date)" >> artifacts/BUILD_INFO.txt
        
    - name: ðŸ“¤ Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: TeemoCat-ISO
        path: artifacts/
        retention-days: 30
        
    - name: ðŸ“Š Create build summary
      run: |
        echo "## ðŸŽ‰ Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ ISO Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Size:** ${{ steps.check_size.outputs.iso_size_mb }} MB" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
        echo "Go to the **Artifacts** section above to download the ISO." >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸ’¬ Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸŽ‰ ISO Build Complete!\n\n**Size:** ${{ steps.check_size.outputs.iso_size_mb }} MB\n\nðŸ“¥ Download from [Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
          })
